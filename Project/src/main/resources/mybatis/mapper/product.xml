<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="product">
    <!-- 상품 목록 가져오기 -->
    <select id="select_product" resultType="user.vo.ProductVO" parameterType="Map">
        <if test="sort != null and sort == 1">
            SELECT
                s.name AS brand,
                p.*,
                COALESCE((
                    SELECT COUNT(*)
                    FROM prod_like l
                    WHERE l.prod_no = p.id AND l.like_status IN ('1', '3')
                    GROUP BY l.prod_no
                ), 0) AS like_count
            FROM product p
            INNER JOIN seller s ON p.seller_no = s.id
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY p.add_date DESC
        </if>
        <if test="sort != null and sort == 2">
            SELECT
                s.name AS brand,
                p.*,
                COALESCE((
                    SELECT COUNT(*)
                    FROM prod_like l
                    WHERE l.prod_no = p.id AND l.like_status IN ('1', '3')
                    GROUP BY l.prod_no
                ), 0) AS like_count
            FROM product p
            INNER JOIN seller s ON p.seller_no = s.id
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY p.saled_price
        </if>
        <if test="sort != null and sort == 3">
            SELECT
                s.name AS brand,
                p.*,
                COALESCE((
                    SELECT COUNT(*)
                    FROM prod_like l
                    WHERE l.prod_no = p.id AND l.like_status IN ('1', '3')
                    GROUP BY l.prod_no
                ), 0) AS like_count
            FROM product p
            INNER JOIN seller s ON p.seller_no = s.id
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY p.saled_price DESC
        </if>
        <if test="sort != null and sort == 4">
            SELECT
                s.name AS brand,
                p.*,
            COALESCE((
                SELECT COUNT(*)
                FROM prod_like l
                WHERE l.prod_no = p.id AND l.like_status IN ('1', '3')
                GROUP BY l.prod_no
            ), 0) AS like_count
            FROM product p
            INNER JOIN seller s ON p.seller_no = s.id
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY p.sale DESC
        </if>
        <if test="sort != null and sort == 5">
            SELECT
                p.*,
                s.name AS seller_name,
                COALESCE(o.count, 0) AS order_count
            FROM product p
            INNER JOIN seller s ON p.seller_no = s.id
            LEFT JOIN (
                SELECT
                    prod_no,
                    COUNT(*) AS count
                FROM shop.order
                WHERE
                    prod_no IS NOT NULL
                GROUP BY prod_no
            ) o ON p.id = o.prod_no
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY order_count DESC
        </if>
    </select>

    <!-- 상품 상세정보 가져오기 -->
    <select id="select_product_details" resultType="user.vo.ProductVO" parameterType="String">
        SELECT
        s.name AS brand,
        p.*,
        COALESCE(COUNT(pl.prod_no), 0) AS like_count
        FROM product p
        INNER JOIN seller s ON p.seller_no = s.id
        LEFT JOIN prod_like pl ON p.id = pl.prod_no AND pl.like_status IN ('1', '3')
        WHERE p.id = #{id}
        GROUP BY p.id, s.name
    </select>

    <!-- 상품 사이즈 정보 가져오기 -->
    <select id="select_size" resultType="user.vo.ProductVO" parameterType="String">
        SELECT i.option_name AS i_option_name, i.count, p.*
        FROM product p
        JOIN inventory i ON i.prod_no = p.id
        WHERE p.id = #{id} AND p.is_del = 0
        ORDER BY
            CASE
                WHEN i.option_name = 'XS' THEN 1
                WHEN i.option_name = 'S' THEN 2
                WHEN i.option_name = 'M' THEN 3
                WHEN i.option_name = 'L' THEN 4
                WHEN i.option_name = 'XL' THEN 5
                WHEN i.option_name = 'XXL' THEN 6
            ELSE 7
        END
    </select>
</mapper>
