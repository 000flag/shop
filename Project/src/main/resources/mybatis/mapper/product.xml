<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="product">
    <!-- 상품 목록 가져오기 -->
    <select id="select_product" resultType="user.vo.ProductVO" parameterType="Map">
        <if test="sort != null and sort == 1">
            SELECT
                s.name AS brand,
                p.*,
                COALESCE((
                    SELECT COUNT(*)
                    FROM prod_like l
                    WHERE l.prod_no = p.id AND l.like_status IN ('1', '3')
                    GROUP BY l.prod_no
                ), 0) AS like_count
            FROM product p
            INNER JOIN seller s ON p.seller_no = s.id
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY p.add_date DESC
        </if>
        <if test="sort != null and sort == 2">
            SELECT
                s.name AS brand,
                p.*,
                COALESCE((
                    SELECT COUNT(*)
                    FROM prod_like l
                    WHERE l.prod_no = p.id AND l.like_status IN ('1', '3')
                    GROUP BY l.prod_no
                ), 0) AS like_count
            FROM product p
            INNER JOIN seller s ON p.seller_no = s.id
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY p.saled_price
        </if>
        <if test="sort != null and sort == 3">
            SELECT
                s.name AS brand,
                p.*,
                COALESCE((
                    SELECT COUNT(*)
                    FROM prod_like l
                    WHERE l.prod_no = p.id AND l.like_status IN ('1', '3')
                    GROUP BY l.prod_no
                ), 0) AS like_count
            FROM product p
            INNER JOIN seller s ON p.seller_no = s.id
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY p.saled_price DESC
        </if>
        <if test="sort != null and sort == 4">
            SELECT s.name AS brand, p.* FROM product p
            INNER JOIN seller s
            ON p.seller_no = s.id
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY p.sale DESC
        </if>
        <if test="sort != null and sort == 5">
            SELECT
                p.*,
                s.name AS seller_name,
                COALESCE(o.count, 0) AS order_count
            FROM product p
            INNER JOIN seller s ON p.seller_no = s.id
            LEFT JOIN (
                SELECT
                    prod_no,
                    COUNT(*) AS count
                FROM shop.order
                WHERE
                    prod_no IS NOT NULL
                GROUP BY prod_no
            ) o ON p.id = o.prod_no
            WHERE p.category_no = #{category_no} AND p.active = 0 AND p.is_del = 0
            ORDER BY order_count DESC
        </if>
    </select>

    <!-- 상품 상세정보 가져오기 -->
    <select id="select_product_details" resultType="user.vo.ProductVO" parameterType="String">
        SELECT s.name AS brand, p.id, p.category_no, p.seller_no, p.name, p.length, p.shoulder, p.chest,
        p.sleeve, p.waist, p.hip, p.thigh, p.rise, p.hem, p.foot_length, p.foot_width, p.ankle_height, p.heel_height, p.price, p.add_date,
        p.view_count, p.inventory, p.active, p.sale, p.prod_image, p.additional_images, p.content, p.saled_price
        FROM product p
        INNER JOIN seller s ON p.seller_no = s.id
        WHERE p.id = ${prod_no}
    </select>

    <!-- 상품 사이즈 정보 가져오기 -->
    <select id="select_size" resultType="user.vo.ProductVO" parameterType="String">
        SELECT i.option_name AS i_option_name, p.name AS name, p.price AS price, p.saled_price AS saled_price, p.chest AS chest,
        p.shoulder AS shoulder, p.length AS length, p.sleeve AS sleeve
        FROM product p
        JOIN inventory i ON i.prod_no = p.id
        WHERE p.name = #{name}
    </select>
</mapper>
